#!/bin/bash
# bash shell ì—ì„œëŠ” í•¨ìˆ˜ì •ì˜ ë¨¼ì €, ì‹¤í–‰ë¡œì§(main flow)ì€ ì•„ë˜ì— ë‘ëŠ” êµ¬ì¡°: ê¹”ë”/ìœ ì§€ë³´ìˆ˜ ìš©ì´

set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

# ==============================================================================
# STEP 0: ì´ˆê¸° ì„¤ì • (Setup)
# ==============================================================================
step_0_setup() {
    echo "STEP 0: ì´ˆê¸° ì„¤ì •"
    
    # .env íŒŒì¼ ë¡œë“œ (python-dotenv í•„ìš”)
    if [ -f ".env" ]; then
        echo "ğŸŒ .env íŒŒì¼ ë¡œë“œ"
        export $(grep -v '^#' .env | xargs)
    fi

    # ìŠ¤í¬ë¦½íŠ¸ê°€ ìˆëŠ” ë””ë ‰í† ë¦¬ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
    PROJECT_ROOT="$SCRIPT_DIR/.."
    cd "$PROJECT_ROOT" || exit 1

    echo "ğŸš€ í”„ë¡œì íŠ¸ ë£¨íŠ¸: $(pwd)"
    
    
    export PYTHONPATH=.
    echo "âœ… ì´ˆê¸° ì„¤ì • ì™„ë£Œ"
}

# ==============================================================================
# STEP 1: ë°ì´í„° ì „ì²˜ë¦¬ (Preprocess Data)
# ==============================================================================
step_1_preprocess() {
    echo -e "\n\nSTEP 1: ë°ì´í„° ì „ì²˜ë¦¬"
    python3 src/data/make_dataset.py
    echo "âœ… ë°ì´í„° ì „ì²˜ë¦¬ ì™„ë£Œ"
}

# ==============================================================================
# STEP 2: ëª¨ë¸ í•™ìŠµ (Train Model)
# ==============================================================================
step_2_train() {
    echo -e "\n\nSTEP 2: ëª¨ë¸ í•™ìŠµ"
    python3 src/models/train.py || true
    echo "âœ… ëª¨ë¸ í•™ìŠµ ì™„ë£Œ"
}

# ==============================================================================
# STEP 3: í‰ê°€ (Evaluation)
# ==============================================================================
step_3_evaluate() {
    echo -e "\n\nSTEP 3: í‰ê°€"
    echo "ğŸ“Š ìµœê³  ì„±ëŠ¥ ëª¨ë¸ í‰ê°€ (auto)"
    eval_output=$(python3 src/models/evaluate.py --auto)
    echo "$eval_output"

    avg_score=$(echo "$eval_output" | grep "Final Score" | grep -o '[0-9.]\+')
    echo -e "\nğŸŒŸ \033[1;36m[âœ”] í‰ê°€ ì™„ë£Œ: final ROUGE ì ìˆ˜ = $avg_score\033[0m"
}

# ==============================================================================
# STEP 4: ì¶”ë¡  (Inference)
# ==============================================================================
step_4_infer() {
    echo -e "\n\nSTEP 4: ì¶”ë¡ "
    echo "ğŸ” ìµœê³  ì„±ëŠ¥ ëª¨ë¸ë¡œ ì¶”ë¡  (auto)"
    python3 src/models/infer.py
    echo "âœ… ì¶”ë¡  ì™„ë£Œ"
}

# ==============================================================================
# ë©”ì¸ ì‹¤í–‰ ë¡œì§ (Main Execution)
# ==============================================================================

step_0_setup

# step_1 ì „ì²˜ë¦¬ ë””ë ‰í† ë¦¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ í•„ìš” ì‹œ ì‹¤í–‰
#PREV_VERSION=$(python - <<PY
#import yaml, sys
#cfg=yaml.safe_load(open('src/config/config.yaml'))
#print(cfg.get('general', {}).get('preprocess_version', 'v1'))
#PY
#)

#if [ ! -f "data/processed/${PREV_VERSION}/train.csv" ]; then
#  echo "ğŸ“‚ ì „ì²˜ë¦¬ëœ ë°ì´í„°ê°€ ì—†ì–´ì„œ ìë™ ì „ì²˜ë¦¬ ì‹¤í–‰(${PREV_VERSION})"
#  step_1_preprocess
#else
#  echo "âœ… ì „ì²˜ë¦¬ ë°ì´í„°(${PREV_VERSION})ê°€ ì´ë¯¸ ì¡´ì¬í•˜ì—¬ ê±´ë„ˆëœë‹ˆë‹¤."
#fi

step_2_train
step_3_evaluate
step_4_infer

echo -e "\n\nğŸ \033[1;32m[ALL DONE] ëª¨ë“  íŒŒì´í”„ë¼ì¸ ë‹¨ê³„ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\033[0m"
echo "ğŸ“‚ ìƒì„±ëœ prediction íŒŒì¼ë“¤:"
ls -lh outputs/predictions/*_model_*.csv
